import React, { useState } from 'react';
import { useContent } from '../contexts/ContentContext';
import { useLanguage } from '../contexts/LanguageContext';
import { getImageUrl } from '../utils/image';
import { FaWhatsapp, FaFacebookMessenger, FaLink, FaShareAlt, FaCalendarAlt } from 'react-icons/fa';
import '../styles/index.css';

const AllFeedPage = () => {
    const { feed } = useContent();
    const { language } = useLanguage();
    const [copySuccess, setCopySuccess] = useState(null);

    const formatDate = (dateString) => {
        if (!dateString) return "";
        const date = new Date(dateString);
        return date.toLocaleDateString(language === 'en' ? 'en-US' : 'ne-NP', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    };

    const handleCopyLink = (itemId) => {
        const url = `${window.location.origin}/feed#post-${itemId}`;
        navigator.clipboard.writeText(url).then(() => {
            setCopySuccess(itemId);
            setTimeout(() => setCopySuccess(null), 2000);
        });
    };

    const shareOnWhatsApp = (item) => {
        const text = encodeURIComponent(`${item.caption || 'Check out this update!'} \n\n ${window.location.origin}/feed#post-${item.id}`);
        window.open(`https://wa.me/?text=${text}`, '_blank');
    };

    const shareOnMessenger = (item) => {
        const url = encodeURIComponent(`${window.location.origin}/feed#post-${item.id}`);
        // FB Messenger sharing via URL is limited, usually redirect to share dialog
        window.open(`https://www.facebook.com/dialog/send?link=${url}&app_id=YOUR_FB_APP_ID&redirect_uri=${url}`, '_blank');
    };

    // Note: Social sharing URLs vary. Using common ones.
    const shareSocial = (platform, item) => {
        const url = encodeURIComponent(`${window.location.origin}/feed#post-${item.id}`);
        const text = encodeURIComponent(item.caption || 'Binisha Enterprises Update');

        let shareUrl = '';
        switch (platform) {
            case 'whatsapp':
                shareUrl = `https://wa.me/?text=${text}%20${url}`;
                break;
            case 'viber':
                shareUrl = `viber://forward?text=${text}%20${url}`;
                break;
            case 'messenger':
                // Messenger is tricky without SDK, but FB share works well
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                break;
            default:
                break;
        }
        if (shareUrl) window.open(shareUrl, '_blank');
    };

    return (
        <section className="social-feed-section">
            <div className="container">
                <div className="section-header center-text">
                    <h2 className="section-title" dangerouslySetInnerHTML={{ __html: language === 'en' ? 'Our <span class="text-accent">Updates</span> & Feed' : 'हाम्रा <span class="text-accent">अपडेटहरू</span> र फिड' }}></h2>
                    <div className="section-line"></div>
                </div>

                <div className="social-feed-container">
                    {feed && feed.map((item, index) => (
                        <div
                            className="social-post-card"
                            key={item.id}
                            id={`post-${item.id}`}
                            style={{ animationDelay: `${index * 0.1}s` }}
                        >
                            {/* Post Header: Date */}
                            <div className="post-header">
                                <div className="post-date">
                                    <FaCalendarAlt className="date-icon" />
                                    <span>{formatDate(item.date || item.createdAt)}</span>
                                </div>
                            </div>

                            {/* Post Caption */}
                            {item.caption && (
                                <div className="post-caption">
                                    <p>{item.caption}</p>
                                </div>
                            )}

                            {/* Post Image */}
                            {item.image_url && (
                                <div className="post-image">
                                    <img src={getImageUrl(item.image_url)} alt="Feed update" loading="lazy" />
                                </div>
                            )}

                            {/* Post Actions */}
                            <div className="post-actions">
                                <span className="share-label">
                                    <FaShareAlt /> {language === 'en' ? 'Share' : 'साझा गर्नुहोस्'}:
                                </span>
                                <div className="action-buttons">
                                    <button
                                        className="action-btn whatsapp"
                                        onClick={() => shareSocial('whatsapp', item)}
                                        title="Share on WhatsApp"
                                    >
                                        <FaWhatsapp />
                                    </button>
                                    <button
                                        className="action-btn viber"
                                        onClick={() => shareSocial('viber', item)}
                                        title="Share on Viber"
                                    >
                                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                            <path d="M17.57 2.1c-.24-.07-.48-.1-.71-.1-.76 0-1.46.33-1.92.91-.46.57-.61 1.33-.42 2.06.34 1.28.18 2.65-.45 3.82L13 10.87c-1.12.63-2.43.83-3.69.57-.73-.15-1.49-.03-2.1.33-.61.37-1.01.99-1.12 1.7-.11.71.09 1.45.54 2.01.44.57 1.11.91 1.83.97l.1.01c.14 0 .28-.02.42-.06.77-.2 1.57-.1 2.27.27.7.37 1.23.99 1.5 1.74.28.75.29 1.57.04 2.33-.23.71-.16 1.48.2 2.13.36.65.95 1.1 1.66 1.26.17.04.34.05.51.05.54 0 1.05-.16 1.49-.47.44-.31.76-.75.91-1.25.26-.88.16-1.83-.29-2.65l-1.01-1.85c-.45-.82-.57-1.78-.34-2.71.23-.93.79-1.74 1.58-2.28 1.12-.76 2.45-1.03 3.75-.76.73.15 1.49.03 2.1-.33.61-.37 1.01-.99 1.12-1.7.11-.71-.09-1.45-.54-2.01-.44-.57-1.11-.91-1.83-.97-.14-.01-.28-.01-.42-.01-.73 0-1.44.25-2.02.72-.58.47-1 1.12-1.18 1.85-.18.73-.1 1.51.22 2.17.32.66.86 1.18 1.52 1.47l.15.06c-.15.4-.41.74-.75.99-.34.25-.75.39-1.18.39-.43 0-.84-.14-1.18-.39-.34-.25-.6-.59-.75-.99l.06-.15c.29-.66.37-1.41.22-2.13-.15-.72-.49-1.37-.96-1.88-.47-.51-1.07-.88-1.74-1.06-.67-.18-1.37-.18-2.04.01-.4-.15-.74-.41-.99-.75s-.39-.75-.39-1.18c0-.43.14-.84.39-1.18s.59-.6.99-.75c-.19.67-.19 1.37-.01 2.04.18.67.55 1.27 1.06 1.74.51.47 1.16.81 1.88.96.72.15 1.47.07 2.13-.22l.15-.06c.4.15.74.41.99.75.25.34.39.75.39 1.18 0 .43-.14.84-.39 1.18s-.59.6-.99.75l.01-.1c.36-.71.91-1.28 1.58-1.63.67-.35 1.43-.49 2.16-.38.73.11 1.4.45 1.89.98.49.53.79 1.21.84 1.94s-.12 1.44-.49 2.04a3.3 3.3 0 0 1-1.48 1.29c-.61.27-1.28.37-1.95.28s-1.32-.41-1.85-.92c-.53-.51-.89-1.18-.99-1.89-.1-.71.05-1.44.43-2.08.38-.64.95-1.14 1.63-1.43l1.86-1.01c.82-.45 1.78-.55 2.65-.29s1.61.85 2.08 1.69c.47.84.66 1.82.53 2.76-.13.94-.61 1.8-1.36 2.42-.75.62-1.69.95-2.65.92-.96-.03-1.88-.45-2.58-1.18a3.3 3.3 0 0 1-.87-1.63c-.15-.77-.07-1.57.23-2.3.3-.73.8-1.34 1.44-1.74l-.06.15c-.15.4-.41.74-.75.99-.34.25-.75.39-1.18.39-.43 0-.84-.14-1.18-.39-.34-.25-.6-.59-.75-.99l.06-.15c.29-.66.37-1.41.22-2.13-.15-.72-.49-1.37-.96-1.88-.47-.51-1.07-.88-1.74-1.06-.67-.18-1.37-.18-2.04.01l-.15.06c.15-.4.15-.84.01-1.25-.14-.41-.4-.77-.73-1.03-.33-.26-.73-.42-1.16-.45-.43-.03-.86.07-1.22.28a3.38 3.38 0 0 0-1.29 1.48c-.27.61-.37 1.28-.28 1.95s.41 1.32.92 1.85c.51.53 1.18.89 1.89.99.71.1 1.44-.05 2.08-.43.64-.38 1.14-.95 1.43-1.63l1.01-1.86c.45-.82.55-1.78.29-2.65s-.85-1.61-1.69-2.08c-.84-.47-1.82-.66-2.76-.53-.94.13-1.8.61-2.42 1.36-.62.75-.95 1.69-.92 2.65.03.96.45 1.88 1.18 2.58.11.11.23.21.35.31l-.22-.1c-.66-.29-1.41-.37-2.13-.22-.72.15-1.37.49-1.88.96-.51.47-.88 1.07-1.06 1.74-.18.67-.18 1.37.01 2.04l-.06-.15c.15.4.41.74.75.99.34.25.75.39 1.18.39.43 0 .84-.14 1.18-.39.34-.25.59-.59.75-.99l-.06.15c-.29.66-.37 1.41-.22 2.13.15.72.49 1.37.96 1.88.47.51 1.07.88 1.74 1.06.67.18 1.37.18 2.04-.01l.15.06c-.4-.15-.74-.41-.99-.75s-.39-.75-.39-1.18c0-.43.14-.84.39-1.18s.59-.6.99-.75c-.15.4-.15.84-.01 1.25.14.41.4.77.73 1.03.33.26.73.42 1.16.45.43.03.86-.07 1.22-.28.61-.35 1.08-.88 1.29-1.48s.22-1.25.01-1.87l-.06-.15c.15.4.41.74.75.99.34.25.75.39 1.18.39s.84-.14 1.18-.39c.34-.25.59-.59.75-.99l-.06.15c-.29.66-.37 1.41-.22 2.13.15.72.49 1.37.96 1.88a3.33 3.33 0 0 0 3.78 1.05c.67-.18 1.27-.55 1.74-1.06.47-.51.81-1.16.96-1.88.15-.72.07-1.47-.22-2.13l-.06-.15c.4.15.84.15 1.25.01.41-.14.77-.4 1.03-.73.26-.33.42-.73.45-1.16.03-.43-.07-.86-.28-1.22a3.38 3.38 0 0 0-1.48-1.29c-.61-.27-1.28-.37-1.95-.28s-1.32.41-1.85.92c-.53.51-.89 1.18-.99 1.89-.1.71.05 1.44.43 2.08.38.64.95 1.14 1.63 1.43l1.86 1.01c.82.45 1.78.55 2.65.29s1.61-.85 2.08-1.69c.47-.84.66-1.82.53-2.76-.13-.94-.61-1.8-1.36-2.42-.75-.62-1.69-.95-2.65-.92-.96.03-1.88.45-2.58 1.18-.7.73-1.14 1.67-1.25 2.65-.11.98.1 1.95.6 2.76l1.01 1.86c.45.82.55 1.78.29 2.65a3.38 3.38 0 0 1-1.69 2.08c-.84.47-1.82.66-2.76.53-.94-.13-1.8-.61-2.42-1.36s-.95-1.69-.92-2.65c.03-.96.45-1.88 1.18-2.58.7-.73 1.64-1.17 2.62-1.25l-.35-.03c-.66.03-1.31.25-1.85.64s-.97.94-1.22 1.57l-1.01 1.86c-.45.82-.55 1.78-.29 2.65s.85 1.61 1.69 2.08c.84.47 1.82.66 2.76.53.94-.13 1.8-.61 2.42-1.36s.95-1.69.92-2.65c-.03-.96-.45-1.88-1.18-2.58l-1.86-1.01c-.82-.45-1.78-.55-2.65-.29s-1.61.85-2.08 1.69c-.47.84-.66 1.82-.53 2.76.13.94.61 1.8 1.36 2.42.11.09.23.17.35.25l-.22-.11c-.6-.29-1.13-.73-1.52-1.29-.39-.56-.6-1.23-.62-1.91-.02-.68.15-1.35.49-1.92.34-.57.85-1.02 1.47-1.29l1.86-1.01c.82-.45 1.48-1.12 1.88-1.91.4-.79.55-1.69.44-2.58-.11-.89-.47-1.73-1.05-2.41s-1.34-1.17-2.21-1.42c-.87-.25-1.8-.25-2.67 0s-1.64.71-2.26 1.3c-.62.59-1.07 1.32-1.3 2.13-.23.81-.22 1.67.04 2.47l.15.54c-.1.25-.26.47-.47.65-.21.18-.46.3-.73.35-.27.05-.54.04-.81-.03-.27-.07-.52-.2-.72-.38a2.12 2.12 0 0 1-.58-1.09c-.19-.77-.18-1.57.04-2.33.22-.76.62-1.45 1.15-2.01.53-.56 1.2-1 1.95-1.27.75-.27 1.57-.34 2.37-.2.8.14 1.54.49 2.14.99.6.5 1.05 1.16 1.3 1.91.25.75.3 1.57.14 2.37-.16.8-.52 1.54-1.02 2.14l-1.86 1.01c-.82.45-1.48 1.12-1.88 1.91s-.55 1.69-.44 2.58c.11.89.47 1.73 1.05 2.41s1.34 1.17 2.21 1.42c.87.25 1.8.25 2.67 0s1.64-.71 2.26-1.3c.62-.59 1.07-1.32 1.3-2.13.23-.81.22-1.67-.04-2.47l-.15-.54c.1-.25.26-.47.47-.65s.46-.3.73-.35c.27-.05.54-.04.81.03.27.07.52.2.72.38.2.18.36.41.46.65a2.12 2.12 0 0 1 .12 1.53c-.19.77-.55 1.48-1.04 2.07-.49.59-1.12 1.03-1.83 1.29-.71.26-1.48.33-2.24.2-.76-.13-1.46-.46-2.04-.94-.58-.48-1.01-1.11-1.25-1.83-.24-.72-.29-1.5-.15-2.26.14-.76.47-1.46.95-2.04.48-.58 1.11-1.01 1.83-1.25.72-.24 1.5-.29 2.26-.15l.54.15c.25-.1.47-.26.65-.47s.3-.46.35-.73c.05-.27.04-.54-.03-.81-.07-.27-.2-.52-.38-.72-.18-.2-.41-.36-.65-.46a2.12 2.12 0 0 0-1.53-.12c-.77.19-1.48.55-2.07 1.04-.59.49-1.03 1.12-1.29 1.83-.26.71-.33 1.48-.2 2.24.13.76.46 1.46.94 2.04.48.58 1.11 1.01 1.83 1.25.72.24 1.5.29 2.26.15.76-.14 1.46-.47 2.04-.95.58-.48 1.01-1.11 1.25-1.83l.15-.54c-.1-.25-.07-.52.07-.75.14-.23.36-.41.61-.5.25-.09.53-.08.77.03.24.11.44.29.56.52.12.23.16.5.11.76l-.15.54c.24.72.29 1.5.15 2.26-.14.76-.47 1.46-.95 2.04-.48.58-1.11 1.01-1.83 1.25-.72.24-1.5.29-2.26.15s-1.46-.47-2.04-.95c-.58-.48-1.01-1.11-1.25-1.83l-.15-.54c-.25.1-.47.26-.65.47s-.3.46-.35.73c-.05.27-.04.54.03.81.07.27.2.52.38.72a2.15 2.15 0 0 0 1.11.58c.77.19 1.57.18 2.33-.04.76-.22 1.45-.62 2.01-1.15.56-.53 1-1.2 1.27-1.95.27-.75.34-1.57.2-2.37-.14-.8-.49-1.54-.99-2.14-.5-.6-1.16-1.05-1.91-1.3-.75-.25-1.57-.3-2.37-.14-.8.16-1.54.52-2.14 1.02a3.36 3.36 0 0 0-1.01 1.86c-.15.82.02 1.67.48 2.39a3.36 3.36 0 0 0 1.86 1.5l1.86 1.01c.82.45 1.5.02 2.03-.51.53-.53.79-1.21.84-1.94s-.12-1.44-.49-2.04a3.3 3.3 0 0 0-1.48-1.29c-.61-.27-1.28-.37-1.95-.28s-1.32.41-1.85.92c-.36.35-.64.77-.82 1.24l-1.63-.58c.32-.82.85-1.55 1.54-2.12s1.53-.98 2.45-1.18c.92-.2 1.87-.13 2.76.2.89.33 1.68.89 2.31 1.62.63.73 1.06 1.62 1.24 2.58.18.96.11 1.95-.2 2.87-.31.92-.85 1.74-1.57 2.39-.72.65-1.59 1.1-2.54 1.3-.95.2-1.93.12-2.84-.23-.91-.35-1.72-.94-2.35-1.71L17.57 2.1z" />
                                        </svg>
                                    </button>
                                    <button
                                        className="action-btn messenger"
                                        onClick={() => shareSocial('messenger', item)}
                                        title="Share on Facebook"
                                    >
                                        <FaFacebookMessenger />
                                    </button>
                                    <button
                                        className={`action-btn copy-link ${copySuccess === item.id ? 'success' : ''}`}
                                        onClick={() => handleCopyLink(item.id)}
                                        title="Copy Link"
                                    >
                                        <FaLink />
                                        {copySuccess === item.id && <span className="tooltip">Copied!</span>}
                                    </button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </section>
    );
};

export default AllFeedPage;
